# Разворачивание проекта в Docker

Проект разворачивается в docker на Linux, например, Ubuntu.

Для загрузки проекта и его зависимостей потребуется настроенный 
доступ к Gitlab [по ключу ssh](https://gitlab.com/profile/keys).

Также для загрузки зависимостей проекта потребуется настроенный 
доступ к Github [по ключу ssh](https://github.com/settings/keys).

Этот ключ должен совпадать с ключом SSH пользователя в Linux, от которого будет вестись разворачивание проекта и работа
с ним (не root).   

## Для чего это нужно

В контейнере docker будет автоматически настроено изолированное от основной системы окружение, в котором
 проект однозначно заведется. Для настройки
аналогичной виртуальной машины или для установки окружения на основной системе потребовалось бы много времени.
 
## Установка docker (если еще не)

**ВАЖНО**. Эти команды нужно выполнять от пользователя в Linux, от которого будет вестись разворачивание
 проекта и работа с ним **(не root)**.

```
sudo apt install docker.io
sudo usermod -a -G docker $USER
```

После этого необходимо перезагрузиться.

Перезагрузиться нужно **обязательно**, без этого **не заработает.**

```
sudo reboot
```

## Скрипты проекта для работы с docker

В проекте есть папка, которая содержит материалы для разворачивания в docker.
Далее по тексту будем считать, что это `deploy/docker`.

## Разворачивание проекта в docker


1. Склонировать репрзиторий.
2. Положить в `deploy/docker/build/data/user` файлы:
   * `id_rsa` с ключом SSH, который будет использоваться для Gitlab/Github.
   * (если есть/требуется) - `db.sql.gz` с дампом БД.
3. Выполнить `deploy/docker/build/build.sh`
   * Это займет минут 10-20, в зависимости от скорости интернета.
4. Ввести пассфразу от ключа SSH - скрипт спрашивает ее в процессе работы. Ключ нужен
 для загрузки репозитория из Gitlab и его приватной зависимости в vendor/.
   * После этого пройдет еще минут 5-15, в зависимости от скорости интернета, и скрипт закончит работу.
4. Посмотреть, что вывел скрипт в конце под заголовком STATUS - должно быть везде yes или "not applicable". 
Если нет - скопировать лог для анализа (целиком от запуска команды до последней выведенной строки).
4. Настроить IP сайта: 
   * Посмотреть IP, который привязался к контейнеру - скрипт выведет его в конце работы (`Ip Address: ...`).
   * Посмотреть имя сайта, по которому он будет открываться, скрипт выведет его в конце работы (`Host: ...`).
   * Прописать в ```/etc/hosts``` соответствие хоста и ip-адреса. 
3. В конце работы скрипт также выведет логин и пароль для входа в админку сайта (вход по ссылке ```имя_сайта/admin```)

Контейнер будет в запущен в конце сборки. Для входа в консоль контейнера можно воспользоваться
скриптом `shell.sh` (см. ниже).
 
## Запуск/останов контейнера и получение доступа к консоли

 * Запуск: ```deploy/docker/run/start.sh```
 * Останов: ```deploy/docker/run/stop.sh```
 * Консоль: ```deploy/docker/run/shell.sh```
 * Консоль от рута: ```deploy/docker/run/root.sh```
  
## Удаление контейнера и всех данных

Если что-то пошло не так, можно удалить все, чтобы начать с чистого листа.

Для этого нужно запустить ```deploy/docker/build/destroy.sh```

## Прочее

### Загрузка дампа mysql

Для загрузки нужно:

 1. разместить дамп внутри проекта, например, в `tmp/db.sql.gz`
 2. зайти в контейнер от рута `deploy/docker/run/root.sh`
 3. выполнить `zcat /app/tmp/db.sql.gz | mysql project`

### ssh-agent

Чтобы внутри докера не набирать каждый раз пассфразу от ключа SSH, при входе в docker через
`shell.sh` автоматически азпускается ssh-agent.

Чтобы добавить в него свой ключ, нужно набрать команду из одной буквы:

```
S
```

Она спросит пассфразу, после чего подключения по SSH до рестарта контейнера не будут
требовать повторного ввода пассфразы.
